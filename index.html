<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gest√£o de Atletas</title>
  <link rel="icon" href="imagens/ACSoccer.png" type="image/x-icon">
  <link rel="icon" href="imagens/ACSoccer.png" sizes="16x16" />
  <link rel="icon" href="imagens/ACSoccer.png" sizes="32x32" type="image/png" />
  <link rel="icon" href="imagens/ACSoccer.png" sizes="48x48" type="image/png" />
  <link rel="apple-touch-icon" href="imagens/ACSoccer.png">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- DataTables CSS -->
  <link href="https://cdn.datatables.net/v/bs5/dt-1.13.6/datatables.min.css" rel="stylesheet" />
  <!-- FullCalendar CSS -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
  <style>
    body{
      background-color: black;
      color: white;
    }
    .photo-thumb {
      width: 40px;
      height: 40px;
      object-fit: cover;
      border-radius: 4px;
    }
    #spinnerCEP {
      position: absolute;
      right: 10px;
      top: 8px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container py-3">
    <!-- Login Screen -->
    <div id="loginScreen" class="d-flex flex-column align-items-center justify-content-center" style="height: 80vh;">
      <h3 class="mb-3">Login - Gest√£o de Atletas</h3>
      <form id="loginForm" class="w-100" style="max-width: 320px;">
        <div class="mb-3">
          <label for="passwordInput" class="form-label">Senha</label>
          <input type="password" id="passwordInput" class="form-control" required />
          <div class="invalid-feedback">Senha incorreta.</div>
        </div>
        <button type="submit" class="btn btn-primary w-100">Entrar</button>
      </form>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="d-none">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Gest√£o de Atletas</h2>
        <button id="btnLogout" class="btn btn-danger">Sair</button>
      </div>

      <!-- Formul√°rio Cadastro/Edi√ß√£o -->
      <div class="card mb-4">
        <div class="card-header">Cadastro / Edi√ß√£o de Atleta</div>
        <div class="card-body">
          <form id="athleteForm" novalidate>
            <input type="hidden" id="athleteId" />
            <div class="row g-3">
              <div class="col-md-6">
                <label for="fullName" class="form-label">Nome Completo <span class="text-danger">*</span></label>
                <input type="text" id="fullName" name="fullName" class="form-control" required />
                <div class="invalid-feedback">Nome √© obrigat√≥rio.</div>
              </div>
              <div class="col-md-3">
                <label for="cpf" class="form-label">CPF <span class="text-danger">*</span></label>
                <input type="text" id="cpf" name="cpf" class="form-control" required />
                <div class="invalid-feedback">CPF inv√°lido ou duplicado.</div>
              </div>
              <div class="col-md-3">
                <label for="birthDate" class="form-label">Data de Nascimento <span class="text-danger">*</span></label>
                <input type="date" id="birthDate" name="birthDate" class="form-control" required />
                <div class="invalid-feedback">Data inv√°lida.</div>
              </div>
              <div class="col-md-4 position-relative">
                <label for="cep" class="form-label">CEP</label>
                <input type="text" id="cep" name="cep" class="form-control" />
                <div id="spinnerCEP" class="spinner-border spinner-border-sm text-primary" role="status"></div>
                <div class="invalid-feedback">CEP inv√°lido.</div>
              </div>
              <div class="col-md-8">
                <label for="address" class="form-label">Endere√ßo</label>
                <input type="text" id="address" name="address" class="form-control" />
              </div>
              <div class="col-md-2">
                <label for="number" class="form-label">N√∫mero</label>
                <input type="text" id="number" name="number" class="form-control" />
              </div>
              <div class="col-md-4">
                <label for="complement" class="form-label">Complemento</label>
                <input type="text" id="complement" name="complement" class="form-control" />
              </div>
              <div class="col-md-3">
                <label for="neighborhood" class="form-label">Bairro</label>
                <input type="text" id="neighborhood" name="neighborhood" class="form-control" />
              </div>
              <div class="col-md-3">
                <label for="city" class="form-label">Cidade</label>
                <input type="text" id="city" name="city" class="form-control" />
              </div>
              <div class="col-md-6">
                <label for="phone" class="form-label">Telefone <span class="text-danger">*</span></label>
                <input type="text" id="phone" name="phone" class="form-control" required />
                <div class="invalid-feedback">Telefone √© obrigat√≥rio.</div>
              </div>
              <div class="col-md-6">
                <label for="responsible" class="form-label">Respons√°vel (se menor de 18 anos)</label>
                <input type="text" id="responsible" name="responsible" class="form-control" />
                <div class="invalid-feedback">Respons√°vel obrigat√≥rio para menores de 18 anos.</div>
              </div>
              <div class="col-md-4">
                <label for="monthlyFee" class="form-label">Valor da Mensalidade (R$)</label>
                <input type="number" id="monthlyFee" name="monthlyFee" class="form-control" min="0" step="0.01" value="20" />
              </div>
              <div class="col-md-4">
                <label for="photo" class="form-label">Foto</label>
                <input type="file" id="photo" name="photo" class="form-control" accept="image/*" />
              </div>
              <div class="col-md-4 d-flex align-items-end">
                <button type="submit" class="btn btn-success w-100">Salvar</button>
              </div>
              <div class="col-12">
                <button type="button" id="btnClearForm" class="btn btn-secondary">Limpar Formul√°rio</button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- Resumo Financeiro -->
      <div class="card mb-4">
        <div class="card-header">Resumo Financeiro</div>
        <div class="card-body" id="financialSummary">
          <p><strong>Caixa Total:</strong> R$ <span id="cashTotal">0.00</span></p>
        </div>
      </div>

      <!-- Registrar Sa√≠da Financeira -->
      <div class="card mb-4">
        <div class="card-header">Registrar Sa√≠da Financeira (Despesa)</div>
        <div class="card-body">
          <form id="expenseForm" class="row g-3">
            <div class="col-md-6">
              <input type="text" class="form-control" id="expenseDesc" placeholder="Descri√ß√£o da despesa" required />
            </div>
            <div class="col-md-3">
              <input type="number" class="form-control" id="expenseAmount" placeholder="Valor (R$)" min="0.01" step="0.01" required />
            </div>
            <div class="col-md-3">
              <button type="submit" class="btn btn-warning w-100">Registrar Sa√≠da</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Bot√µes -->
      <div class="mb-3 d-flex gap-2 flex-wrap">
        <button id="btnExportPdf" class="btn btn-primary">Exportar Lista de Atletas (PDF)</button>
        <button id="btnShowReport" class="btn btn-info">Relat√≥rio Mensal</button>
      </div>

      <!-- Tabela de Atletas -->
      <div class="table-responsive">
        <table id="athleteTable" class="table table-striped table-bordered" style="width:100%">
          <thead>
            <tr>
              <th>ID</th>
              <th>Foto</th>
              <th>Nome</th>
              <th>Idade</th>
              <th>Respons√°vel</th>
              <th>Telefone</th>
              <th>Mensalidade (R$)</th>
              <th>Pago (R$)</th>
              <th>Faltas</th>
              <th>Status Pagamento</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Calend√°rio -->
      <div class="card mt-4">
        <div class="card-header">Calend√°rio de Atividades</div>
        <div class="card-body">
          <div id="calendar"></div>
        </div>
      </div>
    </div>

    <!-- Modal Relat√≥rio Mensal -->
    <div class="modal fade" id="monthlyReportModal" tabindex="-1" aria-labelledby="monthlyReportLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="monthlyReportLabel">Relat√≥rio Mensal</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body" id="reportContent" style="font-size: 0.9rem;"></div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap Bundle JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <!-- DataTables JS -->
  <script src="https://cdn.datatables.net/v/bs5/dt-1.13.6/datatables.min.js"></script>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <!-- IMask -->
  <script src="https://unpkg.com/imask"></script>
  <!-- FullCalendar -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

  <script>
    (() => {
      const PASSWORD = "074708";

      let athletes = [];
      let expenses = [];
      let currentEditId = null;
      let calendarInstance = null;
      let dataTableInstance = null;

      // ====== Utilit√°rios ======

      function showAlert(message, type = "info") {
        const alertId = "alert-" + Date.now();
        const alert = document.createElement("div");
        alert.className = `alert alert-${type} alert-dismissible fade show`;
        alert.id = alertId;
        alert.role = "alert";
        alert.innerHTML = `
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        document.querySelector(".container").prepend(alert);
        setTimeout(() => {
          const el = document.getElementById(alertId);
          if (el) {
            bootstrap.Alert.getOrCreateInstance(el).close();
          }
        }, 5000);
      }

      function formatCPF(value) {
        // Remove tudo que n√£o √© d√≠gito
        let v = value.replace(/\D/g, "");
        // Aplica m√°scara
        v = v.replace(/(\d{3})(\d)/, "$1.$2");
        v = v.replace(/(\d{3})(\d)/, "$1.$2");
        v = v.replace(/(\d{3})(\d{1,2})$/, "$1-$2");
        return v;
      }

      // Valida CPF
      function validateCPF(cpf) {
        cpf = cpf.replace(/[^\d]+/g,'');
        if(cpf.length !== 11 || /^(\d)\1+$/.test(cpf)) return false;

        let sum = 0;
        for(let i = 0; i < 9; i++) {
          sum += parseInt(cpf.charAt(i)) * (10 - i);
        }
        let rev = 11 - (sum % 11);
        if(rev === 10 || rev === 11) rev = 0;
        if(rev !== parseInt(cpf.charAt(9))) return false;

        sum = 0;
        for(let i = 0; i < 10; i++) {
          sum += parseInt(cpf.charAt(i)) * (11 - i);
        }
        rev = 11 - (sum % 11);
        if(rev === 10 || rev === 11) rev = 0;
        if(rev !== parseInt(cpf.charAt(10))) return false;

        return true;
      }

      // Calcula idade a partir da data nascimento (yyyy-mm-dd)
      function calculateAge(birthDate) {
        const today = new Date();
        const birth = new Date(birthDate);
        let age = today.getFullYear() - birth.getFullYear();
        const m = today.getMonth() - birth.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
        return age;
      }

      // Gera ID aleat√≥rio num√©rico √∫nico de 3 d√≠gitos
      function generateId() {
        let id;
        do {
          id = Math.floor(Math.random() * 900) + 100; // 100 a 999
        } while (athletes.some(a => a.id === id));
        return id;
      }

      // Busca endere√ßo via API ViaCEP
      async function fetchAddressByCEP(cep) {
        cep = cep.replace(/\D/g, "");
        if (cep.length !== 8) return null;

        const spinner = document.getElementById("spinnerCEP");
        spinner.style.display = "inline-block";
        try {
          const res = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
          const data = await res.json();
          spinner.style.display = "none";
          if (data.erro) return null;
          return data;
        } catch {
          spinner.style.display = "none";
          return null;
        }
      }

      // ====== LocalStorage ======

      function saveAthletesToStorage() {
        localStorage.setItem("athletes", JSON.stringify(athletes));
      }

      function loadAthletesFromStorage() {
        const stored = localStorage.getItem("athletes");
        athletes = stored ? JSON.parse(stored) : [];
      }

      function saveExpensesToStorage() {
        localStorage.setItem("expenses", JSON.stringify(expenses));
      }

      function loadExpensesFromStorage() {
        const stored = localStorage.getItem("expenses");
        expenses = stored ? JSON.parse(stored) : [];
      }

      // Carrega todos dados
      function loadAllData() {
        loadAthletesFromStorage();
        loadExpensesFromStorage();
        recalcPaymentsAndAbsences();
      }

      // Atualiza paid e absences dos atletas a partir do hist√≥rico
      function recalcPaymentsAndAbsences() {
        athletes.forEach(a => {
          a.paid = a.payments ? a.payments.reduce((sum,p) => sum + p.amount, 0) : 0;
          a.absences = a.absencesDates ? a.absencesDates.length : 0;
        });
      }

      // ====== M√°scaras ======

      function initMasks() {
        IMask(document.getElementById("cpf"), { mask: "000.000.000-00" });
        IMask(document.getElementById("cep"), { mask: "00000-000" });
        IMask(document.getElementById("phone"), {
          mask: [
            { mask: "(00) 00000-0000" },
            { mask: "(00) 0000-0000" }
          ]
        });
      }

      // ====== Formul√°rio ======

      // Valida√ß√£o do formul√°rio atleta
      function validateForm() {
        const form = document.getElementById("athleteForm");
        let valid = true;

        // Nome
        const fullName = form.fullName.value.trim();
        if (!fullName) {
          form.fullName.classList.add("is-invalid");
          valid = false;
        } else {
          form.fullName.classList.remove("is-invalid");
        }

        // CPF
        const cpfRaw = form.cpf.value.trim();
        if (!validateCPF(cpfRaw)) {
          form.cpf.classList.add("is-invalid");
          valid = false;
        } else {
          // Verificar duplicado
          const cpfClean = cpfRaw.replace(/\D/g,"");
          const exists = athletes.some(a => a.cpf.replace(/\D/g,"") === cpfClean && a.id !== currentEditId);
          if (exists) {
            form.cpf.classList.add("is-invalid");
            valid = false;
          } else {
            form.cpf.classList.remove("is-invalid");
          }
        }

        // Data nascimento
        const birthDate = form.birthDate.value;
        if (!birthDate || calculateAge(birthDate) < 0) {
          form.birthDate.classList.add("is-invalid");
          valid = false;
        } else {
          form.birthDate.classList.remove("is-invalid");
        }

        // Telefone
        const phone = form.phone.value.trim();
        if (!phone) {
          form.phone.classList.add("is-invalid");
          valid = false;
        } else {
          form.phone.classList.remove("is-invalid");
        }

        // Respons√°vel se menor de 18
        const age = calculateAge(birthDate);
        const responsible = form.responsible.value.trim();
        if (age < 18 && !responsible) {
          form.responsible.classList.add("is-invalid");
          valid = false;
        } else {
          form.responsible.classList.remove("is-invalid");
        }

        return valid;
      }

      // Preencher formul√°rio para edi√ß√£o
      function fillForm(athlete) {
        currentEditId = athlete.id;
        const form = document.getElementById("athleteForm");
        form.athleteId.value = athlete.id;
        form.fullName.value = athlete.fullName;
        form.cpf.value = athlete.cpf;
        form.birthDate.value = athlete.birthDate;
        form.cep.value = athlete.cep || "";
        form.address.value = athlete.address || "";
        form.number.value = athlete.number || "";
        form.complement.value = athlete.complement || "";
        form.neighborhood.value = athlete.neighborhood || "";
        form.city.value = athlete.city || "";
        form.phone.value = athlete.phone;
        form.responsible.value = athlete.responsible || "";
        form.monthlyFee.value = athlete.monthlyFee ?? 20;
        // Foto n√£o pode ser preenchida (input file)
      }

      // Limpar formul√°rio
      function clearForm() {
        currentEditId = null;
        const form = document.getElementById("athleteForm");
        form.reset();
        form.athleteId.value = "";
        form.querySelectorAll(".is-invalid").forEach(el => el.classList.remove("is-invalid"));
      }

      // ====== Cadastro e edi√ß√£o ======

      async function handleFormSubmit(event) {
        event.preventDefault();
        if (!validateForm()) {
          showAlert("Corrija os campos destacados.", "danger");
          return;
        }
        const form = event.target;
        const id = currentEditId || generateId();
        // Coleta dados do formul√°rio
        const fullName = form.fullName.value.trim();
        const cpf = form.cpf.value.trim();
        const birthDate = form.birthDate.value;
        const cep = form.cep.value.trim();
        const address = form.address.value.trim();
        const number = form.number.value.trim();
        const complement = form.complement.value.trim();
        const neighborhood = form.neighborhood.value.trim();
        const city = form.city.value.trim();
        const phone = form.phone.value.trim();
        const responsible = form.responsible.value.trim();
        const monthlyFee = parseFloat(form.monthlyFee.value) || 20;

        // Foto
        let photoBase64 = null;
        const fileInput = form.photo;
        if (fileInput.files && fileInput.files[0]) {
          photoBase64 = await fileToBase64(fileInput.files[0]);
        }

        // Se √© edi√ß√£o, atualizar atleta
        if (currentEditId) {
          const athlete = athletes.find(a => a.id === currentEditId);
          if (!athlete) {
            showAlert("Atleta n√£o encontrado para edi√ß√£o.", "danger");
            return;
          }
          athlete.fullName = fullName;
          athlete.cpf = cpf;
          athlete.birthDate = birthDate;
          athlete.cep = cep;
          athlete.address = address;
          athlete.number = number;
          athlete.complement = complement;
          athlete.neighborhood = neighborhood;
          athlete.city = city;
          athlete.phone = phone;
          athlete.responsible = responsible;
          athlete.monthlyFee = monthlyFee;
          if (photoBase64) athlete.photoBase64 = photoBase64;
        } else {
          // Novo atleta
          const newAthlete = {
            id,
            fullName,
            cpf,
            birthDate,
            cep,
            address,
            number,
            complement,
            neighborhood,
            city,
            phone,
            responsible,
            monthlyFee,
            photoBase64,
            payments: [],
            absencesDates: [],
            paid: 0,
            absences: 0,
            active: true
          };
          athletes.push(newAthlete);
        }

        saveAthletesToStorage();
        showAlert(currentEditId ? "Atleta atualizado." : "Atleta cadastrado.", "success");
        clearForm();
        renderTable();
        initCalendar();
      }

      // Utilit√°rio para converter arquivo para base64
      function fileToBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = err => reject(err);
          reader.readAsDataURL(file);
        });
      }

      // ====== Excluir atleta ======

      function deleteAthlete(id) {
        if (!confirm("Confirma a exclus√£o do atleta?")) return;
        athletes = athletes.filter(a => a.id !== id);
        saveAthletesToStorage();
        showAlert("Atleta exclu√≠do.", "info");
        renderTable();
        initCalendar();
      }

      // ====== Pagamento ======

      function addPayment(athleteId, amount) {
        const athlete = athletes.find(a => a.id === athleteId);
        if (!athlete) return false;
        const today = new Date().toISOString().slice(0,10);
        athlete.payments = athlete.payments || [];
        athlete.payments.push({ date: today, amount: amount });
        athlete.paid = (athlete.paid ?? 0) + amount;
        saveAthletesToStorage();
        return true;
      }

      // ====== Faltas ======

      function addAbsence(athleteId) {
        const athlete = athletes.find(a => a.id === athleteId);
        if (!athlete) return false;
        const today = new Date().toISOString().slice(0,10);
        athlete.absencesDates = athlete.absencesDates || [];
        athlete.absencesDates.push(today);
        athlete.absences = (athlete.absences ?? 0) + 1;
        saveAthletesToStorage();
        return true;
      }

      // ====== Sa√≠das Financeiras ======

      function addExpense(description, amount) {
        const today = new Date().toISOString().slice(0,10);
        expenses.push({ date: today, description, amount });
        saveExpensesToStorage();
      }

      // ====== Renderiza√ß√£o da tabela ======

      function renderTable() {
        if (dataTableInstance) {
          dataTableInstance.destroy();
        }
        const tbody = document.querySelector("#athleteTable tbody");
        tbody.innerHTML = "";

        athletes.forEach(athlete => {
          const age = calculateAge(athlete.birthDate);
          const paid = athlete.paid ?? 0;
          const fee = athlete.monthlyFee ?? 20;
          const toPay = fee - paid;
          const statusPayment = toPay > 0 ? `<span class="badge bg-danger">Falta pagar R$ ${toPay.toFixed(2)}</span>` : `<span class="badge bg-success">Pago</span>`;
          const responsibleText = age < 18 ? (athlete.responsible || "<i>N√£o informado</i>") : "<i>N√£o necess√°rio</i>";
          const photoImg = athlete.photoBase64
            ? `<img src="${athlete.photoBase64}" alt="Foto" class="photo-thumb">`
            : "";

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${athlete.id}</td>
            <td>${photoImg}</td>
            <td>${athlete.fullName}</td>
            <td>${age}</td>
            <td>${responsibleText}</td>
            <td>${athlete.phone}</td>
            <td>R$ ${fee.toFixed(2)}</td>
            <td>R$ ${paid.toFixed(2)}</td>
            <td>${athlete.absences ?? 0}</td>
            <td>${statusPayment}</td>
            <td>
              <button class="btn btn-sm btn-primary btn-edit" data-id="${athlete.id}" title="Editar">‚úèÔ∏è</button>
              <button class="btn btn-sm btn-danger btn-delete" data-id="${athlete.id}" title="Excluir">üóëÔ∏è</button>
              <button class="btn btn-sm btn-success btn-pay" data-id="${athlete.id}" title="Registrar Pagamento">üí∞</button>
              <button class="btn btn-sm btn-warning btn-absence" data-id="${athlete.id}" title="Registrar Falta">üìÖ</button>
            </td>
          `;
          tbody.appendChild(tr);
        });

        dataTableInstance = new DataTable("#athleteTable", {
          language: {
            url: "https://cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json"
          },
          order: [[0, "asc"]],
          pageLength: 5,
          lengthMenu: [5,10,20,50]
        });
        updateFinancialSummary();
      }

      // Atualiza caixa total
      function updateFinancialSummary() {
        const totalEntradas = athletes.reduce((sum, a) => sum + (a.paid || 0), 0);
        const totalSaidas = expenses.reduce((sum, e) => sum + e.amount, 0);
        const caixa = totalEntradas - totalSaidas;
        document.getElementById("cashTotal").textContent = caixa.toFixed(2);
      }

      // ====== Exportar PDF ======

      async function exportPdf() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.setFontSize(18);
        doc.text("Lista de Atletas", 14, 20);

        const columns = [
          { header: "ID", dataKey: "id" },
          { header: "Nome", dataKey: "fullName" },
          { header: "Idade", dataKey: "age" },
          { header: "Respons√°vel", dataKey: "responsible" },
          { header: "Telefone", dataKey: "phone" },
          { header: "Mensalidade (R$)", dataKey: "monthlyFee" },
          { header: "Pago (R$)", dataKey: "paid" },
          { header: "Faltas", dataKey: "absences" },
          { header: "Status", dataKey: "statusPayment" }
        ];

        const rows = athletes.map(a => {
          const age = calculateAge(a.birthDate);
          const paid = a.paid ?? 0;
          const fee = a.monthlyFee ?? 20;
          const toPay = fee - paid;
          const statusPayment = toPay > 0 ? `Falta pagar R$ ${toPay.toFixed(2)}` : "Pago";
          const responsibleText = age < 18 ? (a.responsible || "N√£o informado") : "N√£o necess√°rio";
          return {
            id: a.id,
            fullName: a.fullName,
            age,
            responsible: responsibleText,
            phone: a.phone,
            monthlyFee: fee.toFixed(2),
            paid: paid.toFixed(2),
            absences: a.absences ?? 0,
            statusPayment
          };
        });

        doc.autoTable({
          columns,
          body: rows,
          startY: 30,
          styles: { fontSize: 8 },
          headStyles: { fillColor: [0, 123, 255] },
        });

        doc.save(`lista_atletas_${new Date().toISOString().slice(0,10)}.pdf`);
      }

      // ====== Relat√≥rio Mensal ======

      function getCurrentMonthYear() {
        const now = new Date();
        return { month: now.getMonth() + 1, year: now.getFullYear() };
      }

      function generateMonthlyReportHtml() {
        const { month, year } = getCurrentMonthYear();

        // Pagamentos do m√™s
        const paymentsInMonth = [];
        athletes.forEach(a => {
          if (!a.payments) return;
          a.payments.forEach(p => {
            const pDate = new Date(p.date);
            if (pDate.getMonth() + 1 === month && pDate.getFullYear() === year) {
              paymentsInMonth.push({ athleteName: a.fullName, photo: a.photoBase64, amount: p.amount, date: p.date });
            }
          });
        });

        // Despesas do m√™s
        const expensesInMonth = expenses.filter(exp => {
          const d = new Date(exp.date);
          return d.getMonth() + 1 === month && d.getFullYear() === year;
        });

        // Somat√≥rios
        const totalEntradas = paymentsInMonth.reduce((sum, p) => sum + p.amount, 0);
        const totalSaidas = expensesInMonth.reduce((sum, e) => sum + e.amount, 0);
        const caixaFinal = totalEntradas - totalSaidas;

        // Faltas do m√™s
        let totalFaltas = 0;
        athletes.forEach(a => {
          if (!a.absencesDates) return;
          totalFaltas += a.absencesDates.filter(dateStr => {
            const d = new Date(dateStr);
            return d.getMonth() + 1 === month && d.getFullYear() === year;
          }).length;
        });

        // Atletas que pagaram no m√™s
        const pagantes = [...new Set(paymentsInMonth.map(p => p.athleteName))];
        // Atletas inativos (active === false)
        const inativos = athletes.filter(a => a.active === false);

        let html = `
          <h5>Resumo Financeiro - ${month.toString().padStart(2,"0")}/${year}</h5>
          <p><strong>Entradas:</strong> R$ ${totalEntradas.toFixed(2)}</p>
          <p><strong>Sa√≠das:</strong> R$ ${totalSaidas.toFixed(2)}</p>
          <p><strong>Caixa Final:</strong> R$ ${caixaFinal.toFixed(2)}</p>
          <p><strong>Total de Faltas no M√™s:</strong> ${totalFaltas}</p>

          <hr/>

          <h5>Entradas Detalhadas</h5>
          <table class="table table-sm table-striped">
            <thead><tr><th>Data</th><th>Foto</th><th>Nome</th><th>Valor (R$)</th></tr></thead>
            <tbody>
        `;
        if (paymentsInMonth.length === 0) {
          html += `<tr><td colspan="4">Nenhum pagamento registrado.</td></tr>`;
        } else {
          paymentsInMonth.forEach(p => {
            const photo = p.photo
              ? `<img src="${p.photo}" alt="Foto" class="photo-thumb">`
              : "";
            html += `<tr><td>${p.date}</td><td>${photo}</td><td>${p.athleteName}</td><td>${p.amount.toFixed(2)}</td></tr>`;
          });
        }
        html += `</tbody></table><hr/>`;

        html += `
          <h5>Sa√≠das Detalhadas</h5>
          <table class="table table-sm table-striped">
            <thead><tr><th>Data</th><th>Descri√ß√£o</th><th>Valor (R$)</th></tr></thead>
            <tbody>
        `;
        if (expensesInMonth.length === 0) {
          html += `<tr><td colspan="3">Nenhuma despesa registrada.</td></tr>`;
        } else {
          expensesInMonth.forEach(e => {
            html += `<tr><td>${e.date}</td><td>${e.description}</td><td>${e.amount.toFixed(2)}</td></tr>`;
          });
        }
        html += `</tbody></table><hr/>`;

        html += `<h5>Atletas que Pagaram no M√™s (${pagantes.length})</h5>`;
        html += pagantes.length > 0 ? `<ul>${pagantes.map(n => `<li>${n}</li>`).join("")}</ul>` : "<p>Nenhum atleta pagante.</p>";

        html += `<h5>Atletas Inativos (${inativos.length})</h5>`;
        html += inativos.length > 0 ? `<ul>${inativos.map(a => `<li>${a.fullName}</li>`).join("")}</ul>` : "<p>Nenhum atleta inativo.</p>";

        return html;
      }

      function showMonthlyReport() {
        const modalEl = document.getElementById("monthlyReportModal");
        const reportContent = document.getElementById("reportContent");
        reportContent.innerHTML = generateMonthlyReportHtml();
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
      }

      // ====== Calend√°rio ======

      function initCalendar() {
        const calendarEl = document.getElementById("calendar");
        if (calendarInstance) {
          calendarInstance.destroy();
          calendarInstance = null;
        }

        const events = [];

        // Faltas (vermelho)
        athletes.forEach(a => {
          if (!a.absencesDates) return;
          a.absencesDates.forEach(date => {
            events.push({
              title: `Falta: ${a.fullName}`,
              start: date,
              color: 'red'
            });
          });
        });

        // Pagamentos (verde)
        athletes.forEach(a => {
          if (!a.payments) return;
          a.payments.forEach(p => {
            events.push({
              title: `Pagamento: ${a.fullName} R$${p.amount.toFixed(2)}`,
              start: p.date,
              color: 'green'
            });
          });
        });

        calendarInstance = new FullCalendar.Calendar(calendarEl, {
          initialView: "dayGridMonth",
          locale: "pt-br",
          height: 600,
          events,
          headerToolbar: {
            left: "prev,next today",
            center: "title",
            right: "dayGridMonth,timeGridWeek,timeGridDay"
          },
          dayMaxEvents: true,
        });

        calendarInstance.render();
      }

      // ====== Eventos ======

      document.getElementById("loginForm").addEventListener("submit", e => {
        e.preventDefault();
        const passInput = document.getElementById("passwordInput");
        if (passInput.value === PASSWORD) {
          document.getElementById("loginScreen").classList.add("d-none");
          document.getElementById("mainApp").classList.remove("d-none");
          passInput.value = "";
          initMasks();
          loadAllData();
          renderTable();
          initCalendar();
        } else {
          passInput.classList.add("is-invalid");
        }
      });

      document.getElementById("passwordInput").addEventListener("input", e => {
        e.target.classList.remove("is-invalid");
      });

      document.getElementById("btnLogout").addEventListener("click", () => {
        document.getElementById("mainApp").classList.add("d-none");
        document.getElementById("loginScreen").classList.remove("d-none");
      });

      document.getElementById("athleteForm").addEventListener("submit", handleFormSubmit);

      document.getElementById("btnClearForm").addEventListener("click", () => {
        clearForm();
      });

      // Bot√µes da tabela (event delegation)
      document.querySelector("#athleteTable tbody").addEventListener("click", e => {
        const target = e.target;
        if (target.classList.contains("btn-edit")) {
          const id = Number(target.getAttribute("data-id"));
          const athlete = athletes.find(a => a.id === id);
          if (athlete) {
            fillForm(athlete);
            window.scrollTo({top:0, behavior:"smooth"});
          }
        } else if (target.classList.contains("btn-delete")) {
          const id = Number(target.getAttribute("data-id"));
          deleteAthlete(id);
        } else if (target.classList.contains("btn-pay")) {
          const id = Number(target.getAttribute("data-id"));
          const athlete = athletes.find(a => a.id === id);
          if (!athlete) return;
          let valueStr = prompt(`Valor do pagamento para ${athlete.fullName} (R$), padr√£o: ${athlete.monthlyFee ?? 20}`);
          if (!valueStr) return;
          let value = parseFloat(valueStr.replace(",", "."));
          if (isNaN(value) || value <= 0) {
            alert("Valor inv√°lido.");
            return;
          }
          addPayment(id, value);
          showAlert(`Pagamento de R$ ${value.toFixed(2)} registrado para ${athlete.fullName}`, "success");
          renderTable();
          initCalendar();
        } else if (target.classList.contains("btn-absence")) {
          const id = Number(target.getAttribute("data-id"));
          const athlete = athletes.find(a => a.id === id);
          if (!athlete) return;
          if (!confirm(`Registrar falta para ${athlete.fullName} na data de hoje?`)) return;
          addAbsence(id);
          showAlert(`Falta registrada para ${athlete.fullName}`, "warning");
          renderTable();
          initCalendar();
        }
      });

      // CEP - buscar endere√ßo
      document.getElementById("cep").addEventListener("blur", async (e) => {
        const cepVal = e.target.value.trim();
        if (!cepVal) return;
        const data = await fetchAddressByCEP(cepVal);
        if (data) {
          document.getElementById("address").value = data.logradouro || "";
          document.getElementById("neighborhood").value = data.bairro || "";
          document.getElementById("city").value = data.localidade || "";
        } else {
          showAlert("CEP n√£o encontrado.", "warning");
        }
      });

      // Registrar sa√≠da financeira
      document.getElementById("expenseForm").addEventListener("submit", e => {
        e.preventDefault();
        const desc = document.getElementById("expenseDesc").value.trim();
        const amountStr = document.getElementById("expenseAmount").value.trim();
        if (!desc || !amountStr) {
          showAlert("Preencha descri√ß√£o e valor da despesa.", "danger");
          return;
        }
        const amount = parseFloat(amountStr);
        if (isNaN(amount) || amount <= 0) {
          showAlert("Valor da despesa inv√°lido.", "danger");
          return;
        }
        addExpense(desc, amount);
        showAlert("Despesa registrada.", "success");
        document.getElementById("expenseForm").reset();
        updateFinancialSummary();
      });

      // Exportar PDF
      document.getElementById("btnExportPdf").addEventListener("click", () => {
        exportPdf();
      });

      // Mostrar relat√≥rio mensal
      document.getElementById("btnShowReport").addEventListener("click", () => {
        showMonthlyReport();
      });

    })();
  </script>
</body>
</html>
